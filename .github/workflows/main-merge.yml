name: Main Branch Merge Protection

on:
  pull_request:
    branches: [ main ]

jobs:
  check-source-branch:
    name: Verify PR Source Branch
    runs-on: ubuntu-latest
    
    steps:
    - name: Check if PR is from develop branch
      run: |
        echo "üîç Checking PR source branch..."
        echo "Base branch: ${{ github.base_ref }}"
        echo "Source branch: ${{ github.head_ref }}"
        echo "PR number: ${{ github.event.number }}"
        echo "Repository: ${{ github.repository }}"
        
        if [[ "${{ github.head_ref }}" != "develop" ]]; then
          echo ""
          echo "‚ùå MERGE REJECTED: PRs to main are only allowed from develop branch"
          echo "üìã Current source branch: ${{ github.head_ref }}"
          echo "‚úÖ Required source branch: develop"
          echo ""
          echo "üìñ Please follow the correct workflow:"
          echo "   1. feature/* ‚Üí develop (via PR)"
          echo "   2. develop ‚Üí main (via PR) ‚Üê You are here"
          echo ""
          exit 1
        fi
        
        echo "‚úÖ PR from develop branch - merge allowed"

    - name: Verify required status checks
      run: |
        echo "üìã This PR should have the following status checks:"
        echo "   ‚úÖ Backend Build"
        echo "   ‚úÖ Backend Unit Tests"
        echo "   ‚úÖ Backend Code Coverage (‚â•90%)"
        echo "   ‚úÖ PR Review Approval"
        echo ""
        echo "üéâ Source branch verification passed!"

  merge-requirements-summary:
    name: Merge Requirements Summary
    runs-on: ubuntu-latest
    needs: [check-source-branch]
    if: always()
    
    steps:
    - name: Generate Requirements Summary
      run: |
        echo "## üîí Main Branch Merge Requirements" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Source branch check
        if [[ "${{ needs.check-source-branch.result }}" == "success" ]]; then
          echo "‚úÖ **Source Branch**: develop (correct)" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ùå **Source Branch**: ${{ github.head_ref }} (must be develop)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üìã Required Status Checks" >> $GITHUB_STEP_SUMMARY
        echo "The following checks must pass before merging:" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] **Backend Build** - Application builds successfully" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] **Backend Unit Tests** - All tests pass" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] **Backend Code Coverage** - Minimum 90% coverage" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] **PR Review** - At least 1 approval required" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.check-source-branch.result }}" == "success" ]]; then
          echo "üéâ **Status**: Ready for merge (pending other status checks)" >> $GITHUB_STEP_SUMMARY
        else
          echo "üö´ **Status**: Cannot merge - incorrect source branch" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Final Status Check
      run: |
        if [[ "${{ needs.check-source-branch.result }}" == "success" ]]; then
          echo "‚úÖ Main branch merge protection passed"
          exit 0
        else
          echo "‚ùå Main branch merge protection failed"
          exit 1
        fi