name: .NET Backend CI

on:
  workflow_call:
    inputs:
      working-directory:
        required: true
        type: string
        default: 'Obligatorio/Material/Codigo/Backend'
    outputs:
      success:
        description: "Backend CI success status"
        value: ${{ jobs.dotnet-ci.outputs.success }}

jobs:
  dotnet-ci:
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.final.outputs.success }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      working-directory: ${{ inputs.working-directory }}
      run: dotnet restore

    - name: Build Application
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "Building .NET application..."
        dotnet build --configuration Release --no-restore
        echo "✅ Build successful"

    - name: Run Tests
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "Running .NET tests..."
        dotnet test --configuration Release --no-build \
          --logger "trx;LogFileName=test-results.trx" \
          --verbosity normal
        echo "✅ All tests passed"

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: dotnet-test-results
        path: ${{ inputs.working-directory }}/TestResults/

    - name: Set success output
      id: final
      run: echo "success=true" >> $GITHUB_OUTPUT