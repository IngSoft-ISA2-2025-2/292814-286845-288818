name: Backend CI Pipeline

on:
  push:
    branches: [ develop, feature/* ]
    paths:
      - 'Obligatorio/Material/Codigo/Backend/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Obligatorio/Material/Codigo/Backend/**'
  workflow_dispatch:

jobs:
  # Job para verificar que PRs a main vengan desde develop
  check-source-branch:
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
    - name: Check if PR is from develop
      run: |
        if [[ "${{ github.head_ref }}" != "develop" ]]; then
          echo "‚ùå PRs to main are only allowed from develop branch"
          echo "Current source branch: ${{ github.head_ref }}"
          exit 1
        fi
        echo "‚úÖ PR from develop branch - allowed"

  # Job para verificar cambios
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changes
      id: changes
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "Obligatorio/Material/Codigo/Backend"; then
          echo "backend=true" >> $GITHUB_OUTPUT
        else
          echo "backend=false" >> $GITHUB_OUTPUT
        fi

  # Job del Backend .NET
  backend-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/backend.yml
    with:
      working-directory: 'Obligatorio/Material/Codigo/Backend'

  # Job de resumen final
  ci-summary:
    runs-on: ubuntu-latest
    needs: [check-source-branch, detect-changes, backend-ci]
    if: always()
    steps:
    - name: CI Pipeline Summary
      run: |
        echo "## üîç Backend CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check source branch results (only for PRs to main)
        if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.base_ref }}" == "main" ]]; then
          if [[ "${{ needs.check-source-branch.result }}" == "success" ]]; then
            echo "‚úÖ **Source Branch Check**: PR from develop - allowed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Source Branch Check**: PRs to main only allowed from develop" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Backend results
        if [[ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ needs.backend-ci.result }}" == "success" ]]; then
            echo "‚úÖ **Backend CI**: All checks passed" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Build successful" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Backend CI**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "‚è≠Ô∏è **Backend CI**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check overall status
      run: |
        # Check source branch first (for PRs to main)
        if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.base_ref }}" == "main" ]]; then
          if [[ "${{ needs.check-source-branch.result }}" != "success" ]]; then
            echo "‚ùå Pipeline failed: PRs to main are only allowed from develop branch"
            exit 1
          fi
        fi
        
        # Check backend CI
        if [[ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ needs.backend-ci.result }}" == "success" ]]; then
            echo "üéâ Backend CI Pipeline completed successfully!"
            exit 0
          else
            echo "‚ùå Backend CI Pipeline failed. Check the logs above."
            exit 1
          fi
        else
          echo "‚è≠Ô∏è No backend changes detected - pipeline skipped."
          exit 0
        fi