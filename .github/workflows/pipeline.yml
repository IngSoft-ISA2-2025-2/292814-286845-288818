name: Backend CI Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Obligatorio/Material/Codigo/Backend/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Obligatorio/Material/Codigo/Backend/**'
  workflow_dispatch:

jobs:
  # Job para verificar cambios
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changes
      id: changes
      run: |
        if git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "Obligatorio/Material/Codigo/Backend"; then
          echo "backend=true" >> $GITHUB_OUTPUT
        else
          echo "backend=false" >> $GITHUB_OUTPUT
        fi

  # Job del Backend .NET
  backend-ci:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend-changed == 'true' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/backend.yml
    with:
      working-directory: 'Obligatorio/Material/Codigo/Backend'

  # Job de resumen final
  ci-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-ci]
    if: always()
    steps:
    - name: CI Pipeline Summary
      run: |
        echo "## ğŸ” Backend CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Backend results
        if [[ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ needs.backend-ci.result }}" == "success" ]]; then
            echo "âœ… **Backend CI**: All checks passed" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Backend CI**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â­ï¸ **Backend CI**: Skipped (no changes)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Check overall status
      run: |
        if [[ "${{ needs.detect-changes.outputs.backend-changed }}" == "true" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ needs.backend-ci.result }}" == "success" ]]; then
            echo "ğŸ‰ Backend CI Pipeline completed successfully!"
            exit 0
          else
            echo "âŒ Backend CI Pipeline failed. Check the logs above."
            exit 1
          fi
        else
          echo "â­ï¸ No backend changes detected - pipeline skipped."
          exit 0
        fi