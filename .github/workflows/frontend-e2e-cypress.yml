name: Cypress E2E Tests

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Obligatorio/Material/Codigo/**'
  workflow_dispatch:

env:
  FRONTEND_DIRECTORY: 'Obligatorio/Material/Codigo/Frontend'
  BACKEND_DIRECTORY: 'Obligatorio/Material/Codigo/Backend'

jobs:
  detect-code-changes:
    name: Detect Code Changes
    runs-on: ubuntu-latest
    outputs:
      code-changed: ${{ steps.changes.outputs.code }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for code changes
      id: changes
      run: |
        echo "ðŸ” Checking for code changes in Obligatorio/Material/Codigo..."
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "Manual trigger - running E2E tests"
          echo "code=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        BASE_SHA="${{ github.event.pull_request.base.sha }}"
        HEAD_SHA="${{ github.sha }}"
        
        if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "Obligatorio/Material/Codigo"; then
          echo "âœ… Code changes detected"
          echo "code=true" >> $GITHUB_OUTPUT
        else
          echo "â­ï¸ No code changes detected"
          echo "code=false" >> $GITHUB_OUTPUT
        fi

  cypress-e2e:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: detect-code-changes
    if: needs.detect-code-changes.outputs.code-changed == 'true'
    
    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: ${{ env.FRONTEND_DIRECTORY }}/package-lock.json

    - name: Cache node modules
      uses: actions/cache@v4
      with:
        path: ${{ env.FRONTEND_DIRECTORY }}/node_modules
        key: ${{ runner.os }}-node-20-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-20-

    - name: Install dependencies for Cypress
      working-directory: ${{ env.FRONTEND_DIRECTORY }}
      run: |
        set +e
        echo "ðŸ“¦ Installing dependencies..."
        echo "Checking package.json typescript version:"
        grep typescript package.json || echo "typescript not found in package.json"
        echo ""
        echo "Attempting npm ci first..."
        npm ci --legacy-peer-deps
        EXIT_CODE=$?
        if [ $EXIT_CODE -ne 0 ]; then
          echo ""
          echo "âš ï¸ npm ci failed with exit code $EXIT_CODE"
          echo "ðŸ“¦ Falling back to npm install to sync lock file..."
          npm install --legacy-peer-deps
          if [ $? -ne 0 ]; then
            echo "âŒ npm install also failed"
            exit 1
          fi
        fi
        echo "âœ… Dependencies installed successfully"

    - name: Set up Docker Compose
      run: |
        echo "ðŸ³ Starting Docker Compose services..."
        docker compose -f Obligatorio/Material/Codigo/docker-compose.yml up -d --build

    - name: Wait for Backend to be ready
      run: |
        echo "â³ Waiting for Backend to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:5000/health || curl -s http://localhost:8080/health; then
            echo "âœ… Backend is up!"
            break
          fi
          echo "Waiting for backend... ($i/30)"
          sleep 5
        done
        
        if ! curl -s http://localhost:5000/health && ! curl -s http://localhost:8080/health; then
          echo "âŒ Backend failed to start"
          echo "ðŸ“‹ Showing docker logs:"
          docker compose -f Obligatorio/Material/Codigo/docker-compose.yml logs
          exit 1
        fi

    - name: Wait for Frontend to be ready
      run: |
        echo "â³ Waiting for Frontend to be ready..."
        for i in {1..30}; do
          if curl -s http://localhost:4200 || curl -s http://localhost:80; then
            echo "âœ… Frontend is up!"
            break
          fi
          echo "Waiting for frontend... ($i/30)"
          sleep 5
        done
        
        if ! curl -s http://localhost:4200 && ! curl -s http://localhost:80; then
          echo "âŒ Frontend failed to start"
          echo "ðŸ“‹ Showing docker logs:"
          docker compose -f Obligatorio/Material/Codigo/docker-compose.yml logs
          exit 1
        fi

    - name: Run Cypress E2E tests
      working-directory: ${{ env.FRONTEND_DIRECTORY }}
      run: |
        echo "ðŸ§ª Running Cypress E2E tests..."
        npx cypress run

    - name: Show Docker Compose logs (on failure)
      if: failure()
      run: |
        echo "ðŸ“‹ Docker Compose logs:"
        docker compose -f Obligatorio/Material/Codigo/docker-compose.yml logs

    - name: Upload Cypress Screenshots (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-screenshots
        path: ${{ env.FRONTEND_DIRECTORY }}/cypress/screenshots
        retention-days: 7

    - name: Upload Cypress Videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-videos
        path: ${{ env.FRONTEND_DIRECTORY }}/cypress/videos
        retention-days: 7

    - name: Tear down Docker Compose
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up Docker Compose..."
        docker compose -f Obligatorio/Material/Codigo/docker-compose.yml down -v

    - name: E2E Tests Summary
      if: always()
      run: |
        echo "## ðŸ§ª Cypress E2E Tests Results" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Node.js Version: 20.x" >> $GITHUB_STEP_SUMMARY
        echo "- Frontend Directory: \`${{ env.FRONTEND_DIRECTORY }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Backend Directory: \`${{ env.BACKEND_DIRECTORY }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… **Status**: All E2E tests passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status**: Some E2E tests failed" >> $GITHUB_STEP_SUMMARY
          echo "- Check the uploaded screenshots and videos for details" >> $GITHUB_STEP_SUMMARY
        fi
  
  skip-cypress-e2e:
    name: Cypress E2E Tests
    runs-on: ubuntu-latest
    needs: detect-code-changes
    if: needs.detect-code-changes.outputs.code-changed != 'true'
    
    steps:
    - name: Skip Cypress E2E tests
      run: |
        echo "â­ï¸ Skipping Cypress E2E tests - no code changes detected in Obligatorio/Material/Codigo/"
        echo "âœ… This check passes automatically when no code changes are present"
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ§ª Cypress E2E Tests Results" >> $GITHUB_STEP_SUMMARY
        echo "â­ï¸ **Status**: Skipped (no code changes detected)" >> $GITHUB_STEP_SUMMARY
        echo "- This check passes automatically when no code changes are present in \`Obligatorio/Material/Codigo/\`" >> $GITHUB_STEP_SUMMARY