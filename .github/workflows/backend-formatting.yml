name: Backend Code Formatting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  WORKING_DIRECTORY: 'Obligatorio/Material/Codigo/Backend'

jobs:
  detect-backend-changes:
    name: Detect Backend Changes
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check for backend changes
      id: changes
      run: |
        echo "ðŸ” Checking for backend changes..."
        
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "Manual trigger - running formatting check"
          echo "backend=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # For pull requests, compare against base branch
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"
        else
          # For pushes, compare with previous commit
          BASE_SHA="${{ github.event.before }}"
          HEAD_SHA="${{ github.sha }}"
        fi
        
        # Check if backend files changed
        if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "Obligatorio/Material/Codigo/Backend"; then
          echo "âœ… Backend changes detected"
          echo "backend=true" >> $GITHUB_OUTPUT
        else
          echo "â­ï¸ No backend changes detected - formatting check will skip"
          echo "backend=false" >> $GITHUB_OUTPUT
        fi

  formatting:
    name: Backend Code Formatting
    runs-on: ubuntu-latest
    needs: detect-backend-changes
    if: always()
    
    steps:
    - name: Skip if no backend changes
      if: needs.detect-backend-changes.outputs.backend-changed != 'true'
      run: |
        echo "â­ï¸ Skipping backend formatting check - no backend changes detected"
        echo "âœ… This check passes automatically when no backend changes are present"
        exit 0
        
    - name: Checkout code
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      uses: actions/checkout@v4

    - name: Setup .NET
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    - name: Cache NuGet packages
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ðŸ”„ Restoring dependencies for formatting check..."
        dotnet restore > /dev/null

    - name: Install dotnet format tool
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      run: |
        echo "ðŸ”§ Installing dotnet format tool..."
        dotnet tool install -g dotnet-format || echo "Tool already installed"
        dotnet tool list -g | grep dotnet-format || echo "Tool not found in global list"

    - name: Verify .editorconfig exists
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ðŸ” Checking for .editorconfig file..."
        if [ -f ".editorconfig" ]; then
          echo "âœ… .editorconfig found"
          echo "Content preview:"
          head -20 .editorconfig
        else
          echo "âŒ .editorconfig not found - this might cause formatting issues"
          echo "Current directory contents:"
          ls -la
        fi

    - name: Apply and verify code formatting
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ðŸ” Checking and fixing code formatting..."
        
        # First pass: Apply formatting to fix any issues
        echo "ðŸ“ Applying code formatting..."
        dotnet format --verbosity minimal
        
        echo "ðŸ” Verifying formatting is now correct..."
        # Second pass: Verify no more changes are needed
        if dotnet format --verify-no-changes --verbosity minimal; then
          echo "âœ… Code formatting is correct"
        else
          echo "âŒ Code formatting still has issues after applying fixes"
          echo ""
          echo "This could indicate a configuration problem. Running diagnostic check..."
          dotnet format --verify-no-changes --verbosity diagnostic
          
          echo ""
          echo "ðŸ”§ The code has been formatted, but you may need to:"
          echo "1. Check .editorconfig settings"
          echo "2. Ensure consistent line endings (LF vs CRLF)"
          echo "3. Verify all files follow the same formatting rules"
          exit 1
        fi

    - name: Check for common formatting issues
      if: needs.detect-backend-changes.outputs.backend-changed == 'true'
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: |
        echo "ðŸ” Checking for common formatting issues..."
        
        # Check for tabs vs spaces
        if grep -r $'\t' --include="*.cs" .; then
          echo "âŒ Found tabs in C# files (should use spaces)"
        else
          echo "âœ… No tabs found in C# files"
        fi
        
        # Check for trailing whitespace
        if grep -r ' $' --include="*.cs" .; then
          echo "âŒ Found trailing whitespace in C# files"
        else
          echo "âœ… No trailing whitespace found"
        fi

    - name: Upload formatting report
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: formatting-report
        path: |
          ${{ env.WORKING_DIRECTORY }}/format-report.json
          ${{ env.WORKING_DIRECTORY }}/.editorconfig
        retention-days: 5

    - name: Formatting Summary
      if: always()
      run: |
        if [ "${{ needs.detect-backend-changes.outputs.backend-changed }}" != "true" ]; then
          echo "## â­ï¸ Backend Code Formatting - Skipped" >> $GITHUB_STEP_SUMMARY
          echo "No backend changes detected in this commit/PR" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status**: Passed (no formatting check needed)" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ðŸŽ¨ Code Formatting Results" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Formatting Status**: All code properly formatted" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Formatting Status**: Issues found" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- .NET Version: 6.0" >> $GITHUB_STEP_SUMMARY
          echo "- Working Directory: ${{ env.WORKING_DIRECTORY }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tool: dotnet format" >> $GITHUB_STEP_SUMMARY
        fi